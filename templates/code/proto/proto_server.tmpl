{{- /* dot == render.Server */}}

{{define "code/proto/server/newFunction"}}
func New{{ . | goIDUpper }}(producer {{goQualU .Protocol "Producer"}}, consumer {{goQualU .Protocol "Consumer"}}) *{{. | goIDUpper}} {
    return &{{. | goIDUpper}}{
        producer: producer,
        consumer: consumer,
    }
}
{{- end}}

{{define "code/proto/server/securityInterface"}}
type {{. | goIDUpper}}Security interface {
    {{. | goIDUpper }}Security()
}
{{- end}}

{{define "code/proto/server/connectFunctions"}}
{{- if and .IsPublisher .IsSubscriber}}{{/*FIXME: why 'and' here instead of 'or'?*/}}
{{- with impl .Protocol}}

type {{ $ | goIDUpper }}Closable struct {
    {{$ | goIDUpper}}
}

func (c {{ $ | goIDUpper }}Closable) Close() error {
    var err error
    if v, ok := any(c.producer).({{goQual "io.Closer"}}); ok {
        err = {{goQual "errors.Join"}}(err, v.Close())
    }
    if v, ok := any(c.consumer).({{goQual "io.Closer"}}); ok {
        err = {{goQual "errors.Join"}}(err, v.Close())
    }
    return err
}

{{- with tryTmpl (print "code/proto/" $.Protocol "/server/impl/" .Name "/connectFunction") $}}
    {{.}}
{{- else}}
    func Connect{{ $ | goIDUpper }}Bidi(
        ctx {{goQual "context.Context"}},
        url *{{goQual "net/url.URL"}},
        {{with $.SecuritySchemes}}security {{$ | goIDUpper}}Security,{{end}}
    ) (*{{ $ | goIDUpper }}Closable, error) {
        var bindings *{{goQualU .Protocol "ServerBindings"}}
        {{- if $.BindingsProtocols | has $.Protocol}}
            bindings = {{goQualR "ToPtr"}}({{goPkg $}}{{goIDUpper $}}ServerBindings{}.{{$.Protocol | goIDUpper}}())
        {{- end}}
        client, err := {{goPkg .}}NewClient(ctx, url, bindings, {{if $.SecuritySchemes}}security{{else}}nil{{end}})
        if err != nil {
            return nil, err
        }
        producer, consumer := client, client
        return &{{ $ | goIDUpper }}Closable{
            {{$ | goIDUpper}}{producer: producer, consumer: consumer},
        }, nil
    }
{{- end}}

{{- if $.IsPublisher}}
    {{- with tryTmpl (print "code/proto/" $.Protocol "/server/impl/" .Name "/connectProducerFunction") $}}
        {{.}}
    {{- else}}
        func Connect{{ $ | goIDUpper }}Producer(
            ctx {{goQual "context.Context"}},
            url *{{goQual "net/url.URL"}},
            {{with $.SecuritySchemes}}security {{$ | goIDUpper}}Security,{{end}}
        ) (*{{ $ | goIDUpper }}Closable, error) {
            var bindings *{{goQualU $.Protocol "ServerBindings"}}
            {{- if $.BindingsProtocols | has $.Protocol}}
                bindings = {{goQualR "ToPtr"}}({{goPkg $}}{{goIDUpper $}}ServerBindings{}.{{$.Protocol | goIDUpper}}())
            {{- end}}
            producer, err := {{goPkg .}}NewClient(ctx, url, bindings, {{if $.SecuritySchemes}}security{{else}}nil{{end}})
            if err != nil {
                return nil, err
            }
            return &{{ $ | goIDUpper }}Closable{
                {{$ | goIDUpper}}{producer: producer},
            }, nil
        }
    {{- end}}
{{- end}}

{{- if $.IsSubscriber}}
    {{- with tryTmpl (print "code/proto/" $.Protocol "/server/impl/" .Name "/connectConsumerFunction") $}}
        {{.}}
    {{- else}}
        func Connect{{ $ | goIDUpper }}Consumer(
            ctx {{goQual "context.Context"}},
            url *{{goQual "net/url.URL"}},
            {{with $.SecuritySchemes}}security {{$ | goIDUpper}}Security,{{end}}
        ) (*{{ $ | goIDUpper }}Closable, error) {
            var bindings *{{goQualU $.Protocol "ServerBindings"}}
            {{- if $.BindingsProtocols | has $.Protocol}}
                bindings = {{goQualR "ToPtr"}}({{goPkg $}}{{goIDUpper $}}ServerBindings{}.{{$.Protocol | goIDUpper}}())
            {{- end}}
            consumer, err := {{goPkg .}}NewClient(ctx, url, bindings, {{if $.SecuritySchemes}}security{{else}}nil{{end}})
            if err != nil {
                return nil, err
            }
            return &{{ $ | goIDUpper }}Closable{
                {{$ | goIDUpper}}{consumer: consumer},
            }, nil
        }
    {{- end}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}

{{define "code/proto/server/channelOpenMethods"}}
{{- range .BoundChannels}}
    {{- if .ActiveProtocols | has $.Protocol }}
        func (s {{$ | goIDUpper}}) Open{{ . | goIDUpper }}{{$.Protocol | goIDUpper}}(
            ctx {{goQual "context.Context"}},
            {{with .ParametersType}}params {{ . | goUsage }},{{end}}
            {{if .BoundOperations}}opBindings *{{goQualU $.Protocol "OperationBindings"}},{{end}}
            {{if .BoundOperations}}security {{goQualR "AnySecurityScheme"}},{{end}}
        ) (*{{goPkg .}}{{ . | goIDUpper }}{{$.Protocol | goIDUpper}}, error) {
            return {{goPkg .}}Open{{ . | goIDUpper }}{{$.Protocol | goIDUpper}}(
                ctx, s, {{if .ParametersType}}params,{{end}}{{if .BoundOperations}}opBindings, security,{{end}}
            )
        }
    {{- end}}
{{- end}}
{{- end}}

{{define "code/proto/server/operationOpenMethods"}}
{{- range .BoundOperations}}
    {{- if .ActiveProtocols | has $.Protocol }}
        func (s {{$ | goIDUpper}}) Open{{ . | goIDUpper }}{{$.Protocol | goIDUpper}}(
            ctx {{goQual "context.Context"}},
            {{with .Channel.ParametersType}}params {{ . | goUsage }},{{end}}
            {{if .SecuritySchemes}}security {{goPkg .}}{{. | goIDUpper}}Security,{{end}}
        ) (*{{goPkg .}}{{ . | goIDUpper }}{{$.Protocol | goIDUpper}}, error) {
            return {{goPkg .}}Open{{ . | goIDUpper }}{{$.Protocol | goIDUpper}}(
                ctx, s, {{if .Channel.ParametersType}}params, {{end}}{{if .SecuritySchemes}}security, {{end}}
            )
        }
    {{- end}}
{{- end}}
{{- end}}

{{define "code/proto/server/commonMethods" }}
func (s {{. | goIDUpper}}) Name() string {
    return "{{ . | goIDUpper }}"
}

func (s {{. | goIDUpper}}) Producer() {{goQualU .Protocol "Producer"}} {
    return s.producer
}

func (s {{. | goIDUpper}}) Consumer() {{goQualU .Protocol "Consumer"}} {
    return s.consumer
}

{{- if .BindingsProtocols | has .Protocol}}
func (s {{. | goIDUpper}}) Bindings() {{goQualU .Protocol "ServerBindings"}} {
    return {{goPkg $}}{{goIDUpper $}}ServerBindings{}.{{.Protocol | goIDUpper}}()
}
{{- end}}

{{- end}}