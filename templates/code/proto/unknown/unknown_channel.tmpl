{{- /* dot == render.ProtoChannel */}}
{{template "code/proto/channel/newFunction" .}}

type {{ .Channel | goIDUpper }}Server{{.Protocol | goIDUpper}} interface {
    Open{{.Channel | goIDUpper}}{{.Protocol | goIDUpper}}({{goPkgExt "context"}}Context{{if .Parameters.Len}},{{ goIDUpper .Channel}}Parameters{{end}}{{if .BoundOperations}},{{goPkgRun}}AnySecurityScheme{{end}}) (*{{. | goIDUpper}}{{.Protocol | goIDUpper}}, error)
    {{if .IsPublisher}}Producer() {{goPkgUtil .Protocol}}Producer{{end}}
    {{if .IsSubscriber}}Consumer() {{goPkgUtil .Protocol}}Consumer{{end}}
}

func Open{{ .Channel | goIDUpper }}{{.Protocol | goIDUpper}}(
    ctx {{goPkgExt "context"}}Context,
    server {{.Channel | goIDUpper }}Server{{.Protocol | goIDUpper}},
    {{if .Parameters.Len}}params {{goIDUpper $}}Parameters,{{end}}
    {{if .BoundOperations}}security {{goPkgRun}}AnySecurityScheme,{{end}}
) (*{{. | goIDUpper}}{{.Protocol | goIDUpper}}, error) {
    var err error

    {{- if or .IsPublisher .IsSubscriber}}
        address, err := {{.Channel | goIDUpper}}Address({{if .Parameters.Len}}params{{end}}).Expand()
        if err != nil {
            return nil, err
        }
    {{- end}}
    {{- if .IsPublisher}}
        var publisher {{goPkgUtil .Protocol}}Publisher
        producer := server.Producer()
        if producer != nil {
            publisher, err = producer.Publisher(
                ctx,
                address,
                {{if .BoundOperations}}security{{else}}nil{{end}},
            )
            if err != nil {
                return nil, err
            }
        }
    {{- end}}
    {{- if .IsSubscriber}}
        var subscriber {{goPkgUtil .Protocol}}Subscriber
        consumer := server.Consumer()
        if consumer != nil {
            subscriber, err = consumer.Subscriber(
                ctx,
                address,
                {{if .BoundOperations}}security{{else}}nil{{end}},
            )
            if err != nil {
                return nil, err
            }
        }
    {{- end}}

    return New{{ .Channel | goIDUpper }}{{.Protocol | goIDUpper}}(
        {{ if .Parameters.Len}}params,{{end}}
        {{ if .IsPublisher}}publisher,{{end}}
        {{ if .IsSubscriber}}subscriber,{{end}}
    ), nil
}

type {{. | goIDUpper}}{{.Protocol | goIDUpper}} struct {
    address    {{goPkgRun}}ParamString
    {{if .IsPublisher}}publisher  {{goPkgUtil .Protocol}}Publisher{{end}}
    {{if .IsSubscriber}}subscriber {{goPkgUtil .Protocol}}Subscriber{{end}}
}

{{template "code/proto/channel/commonMethods" .}}
{{if .IsPublisher}}{{template "code/proto/channel/publishMethods" .}}{{end}}
{{if .IsSubscriber}}{{template "code/proto/channel/subscribeMethods" .}}{{end}}
