{{- /* dot == render.Renderable: Ref -> render.Message or render.Message */}}
{{- with $message := deref .}}

{{- if and .BindingsType (ndefined .BindingsType)}}
    {{- .BindingsType| godef }}
    {{- range $proto := .BindingsProtocols}}
        {{- $bindingsValue := $message.ProtoBindingsValue $proto}}
        func (c {{ $message.BindingsType | gousage }}) {{ $proto | goid }}() {{$bindingsValue.Type | gousage}} {
            b := {{$bindingsValue| gousage}}
            {{- with $message.Bindings}}
                {{- $jvals := .JSONValues.GetOrEmpty $proto}}
                {{- range $jval := $jvals.Entries}}
                    {{ $jval.Key | toCamelCase }} := {{$jval.Value | golit}}
                    _ = {{goqual "encoding/json.Unmarshal"}}([]byte({{$jval.Key | toCamelCase }}), &b.{{$jval.Key}})
                {{- end}}
            {{- end}}
            return b
        }
    {{- end}}
{{- end }}

{{- $headersType := coalesce .HeadersType .HeadersFallbackType}}

{{- if and (ndefined .OutType) .IsPublisher }}
{{.OutType| godef}}

func (m *{{ .OutType | goid }}) WithPayload(payload {{.PayloadType | gousage}}) *{{ .OutType | goid }} {
    m.Payload = payload
    return m
}

func (m *{{ .OutType | goid }}) WithHeaders(headers {{$headersType | gousage}}) *{{ .OutType | goid }} {
    m.Headers = headers
    return m
}

{{- with visible .CorrelationID}}
func (m {{ $message.OutType | goid }}) SetCorrelationID(value {{template "correlationID/outgoing/varType" $message}}) {
    {{template "correlationID/setter" $message}}
}
{{- end}}
{{- end}}

{{- if print "Message" (goid $) | ndefined}}
    {{- if .IsSubscriber}}
        type {{ $ | goid }}IncomingMessage interface {
            Payload() {{.PayloadType | gousage}}
            Headers() {{$headersType | gousage}}
            {{- with visible .CorrelationID}}
            CorrelationID() (value {{template "correlationID/incoming/varType" $message}}, err error)
            {{- end}}
        }
        {{- def .InType }}

        // New{{ $ | goid }}In is meant to be used by the generated code to create a new message. The user code
        // should not use this function directly.
        func New{{ $ | goid }}In(payload {{.PayloadType | gousage}}, headers {{$headersType | gousage}}) *{{ .InType| gousage }} {
            return &{{ .InType | gousage }}{payload: payload, headers: headers}
        }
    {{- end}}
{{- end}}

{{- if and (ndefined .InType) .IsSubscriber }}
{{.InType| godef}}

func (m *{{ .InType | goid }}) Payload() {{.PayloadType | gousage}} {
    return m.payload
}

func (m *{{ .InType | goid }}) Headers() {{$headersType | gousage}} {
    return m.headers
}

{{- with visible .CorrelationID}}
func (m {{ $message.InType | goid }}) CorrelationID() (value {{template "correlationID/incoming/varType" $message}}, err error) {
    {{template "correlationID/getter" $message}}
    return
}
{{- end}}
{{- end}}

{{- print "Message" (goid $) | def }}

{{- end}}
