import (
	"context"
	"fmt"
	"net/url"

	"github.com/gobwas/ws"
)

func NewProducer(serverURL *url.URL, bindings *{{goPkgUtil "ws"}}ServerBindings, security {{goPkgRun}}AnySecurityScheme) *ProduceClient {
	return &ProduceClient{
		bindings:  bindings,
		serverURL: serverURL,
	}
}

type ProduceClient struct {
	bindings  *{{goPkgUtil "ws"}}ServerBindings
	serverURL *url.URL
}

func (p ProduceClient) Publisher(ctx context.Context, address string, chb *{{goPkgUtil "ws"}}ChannelBindings, opb *{{goPkgUtil "ws"}}OperationBindings, security {{goPkgRun}}AnySecurityScheme) ({{goPkgUtil "ws"}}Publisher, error) {
	if chb != nil && chb.Method != "" && chb.Method != "GET" {
		return nil, fmt.Errorf("unsupported method %s", chb.Method)
	}
	u := p.serverURL.JoinPath(address)
	netConn, _, _, err := ws.Dial(ctx, u.String())
	if err != nil {
		return nil, err
	}

	return NewChannel(chb, opb, netConn, true), nil
}
